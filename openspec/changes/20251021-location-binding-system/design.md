# 位置强绑定系统 - 设计文档

## 架构概览

```
┌─────────────────────────────────────────┐
│         玩家状态 (Player)               │
├─────────────────────────────────────────┤
│  - current_location_id: u32             │
│  - location_state: PlayerLocationState  │
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│       位置系统 (Location)               │
├─────────────────────────────────────────┤
│  - id, name, environment                │
│  - connections: Vec<u32>                │
│  - wild_pokemon_pool                    │
│  - unlock_requirement                   │
│  - stat_bonus: EnvironmentBonus         │
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│    解锁条件 (Requirements)              │
├─────────────────────────────────────────┤
│  - required_level: u32                  │
│  - required_badges: Vec<u32>            │
│  - required_pokemon_count: Option<u32>  │
└─────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────┐
│   野生宝可梦 (WildPokemon)              │
├─────────────────────────────────────────┤
│  - pokemon_pool: Vec<WildPokemonSpawn>  │
│  - encounter_rate: f32                  │
│  - preview_system                       │
└─────────────────────────────────────────┘
```

## 关键决策

### 1. 为什么位置强绑定?

**方案对比:**

| 方案 | 优点 | 缺点 |
|------|------|------|
| 强绑定 (选中) | 清晰的位置感、易于管理状态、叙事性强 | 需要菜单移动 |
| 自由漂浮 | 自由度高 | 状态管理复杂、缺少位置感 |
| 混合模式 | 平衡 | 复杂度中等 |

**选择理由**: 强绑定提供了更好的 RPG 体验和清晰的游戏进度感。

### 2. 环境加成幅度

**为什么是 ±10%?**

- 太小 (±1-5%): 玩家察觉不到
- 合适 (±10%): 战术相关但不主导胜负
- 太大 (±20%+): 打破游戏平衡

**具体数值:**
```
Grassland (草地):     速度 +10%
Forest (森林):        防守 +10%
Cave (洞穴):          特攻 +10%
Water (水域):         特防 +10%
Mountain (山地):      攻击 +10%
City (城市):          所有属性 +5%
```

### 3. 解锁条件设计

**采用多条件 AND 模式:**
```rust
pub struct LocationRequirement {
    pub required_level: u32,           // 玩家队伍最低等级
    pub required_badges: Vec<u32>,     // 需要的徽章
    pub required_pokemon_count: Option<u32>, // 需要的宝可梦数量
}
```

**渐进解锁映射:**
- 常青小镇 (ID:101): 起始 (无条件)
- 常青森林 (ID:102): Lv3
- 华石镇 (ID:103): Lv5
- 月见山 (ID:104): Lv7 + 0徽章
- 华蓝市 (ID:105): Lv15 + 1徽章
- ... 逐步递进

### 4. 地点连接性

**图论模型:**
```
常青小镇(101)
    ├─ 常青森林(102)
    │    └─ 华石镇(103)
    │         └─ 月见山(104)
    │              └─ 华蓝市(105)
    │                  └─ ...
    └─ [其他地点链]
```

**实现方式:**
```rust
pub struct Location {
    pub connected_locations: Vec<u32>, // 可到达的地点 ID
}
```

## 数据流

### 移动流程

```
玩家选择移动
    ↓
加载当前位置的连接地点列表
    ↓
检查每个地点的解锁条件:
    - 等级是否足够?
    - 徽章是否足够?
    ↓
显示可达和已锁定的地点
    ↓
玩家选择目标
    ↓
移动到新位置
    ↓
记录访问状态
    ↓
显示新位置信息
```

### 野生遭遇流程

```
玩家选择探索
    ↓
根据地点遭遇率判断是否有遭遇
    ↓
从地点的宝可梦池随机选择:
    1. 根据 spawn_rate 加权随机
    2. 根据 level_min/max 随机等级
    ↓
应用环境加成 (预览):
    显示原始属性 + 加成后属性
    ↓
显示遭遇预览
    ↓
玩家选择:
    - 捕捉
    - 战斗
    - 逃跑
```

## 模块职责

| 模块 | 职责 |
|------|------|
| `game/location.rs` | 位置数据结构、查询接口 |
| `game/environment.rs` | 环境加成计算 |
| `game/requirements.rs` | 解锁条件检查 |
| `game/wild_pokemon.rs` | 野生宝可梦管理 |
| `data/locations_data.rs` | 位置数据定义 |
| `cli/location_menu.rs` | 位置相关菜单 |
| `main.rs` | 游戏循环修改 |

## 类型安全考虑

所有类型都使用 Rust 类型系统确保安全:
- 无 `unsafe` 代码
- `Result<T, E>` 处理错误
- `Option<T>` 表示可选值
- `Serialize/Deserialize` 支持存档

## 性能考虑

- 地点数据使用 HashMap 快速查询 (O(1))
- 宝可梦池使用权重快速采样
- 解锁条件检查 O(n) 其中 n=条件数量 (通常 <5)
- 无循环依赖

## 扩展性

未来可扩展的方向:
1. 任务系统集成
2. 地点事件系统
3. 天气系统 (进一步影响遭遇)
4. 时间系统 (昼夜影响遭遇)
5. 传送系统 (快速旅行)

这些都可以在不改变核心架构的情况下添加。

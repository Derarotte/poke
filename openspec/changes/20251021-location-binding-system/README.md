# 位置强绑定与地图解锁系统 - OpenSpec 提案

## 📋 提案完整性检查清单

- [x] **proposal.md** - 提案概述
- [x] **design.md** - 设计文档和架构决策
- [x] **specs/** - 详细规范
  - [x] `location-binding/spec.md` - 位置绑定规范
  - [x] `environment-bonus/spec.md` - 环境加成规范
  - [x] `map-unlocking/spec.md` - 地图解锁规范
  - [x] `wild-pokemon-system/spec.md` - 野生宝可梦规范
- [x] **tasks.md** - 实现任务列表

## 📝 提案概述

这个 OpenSpec 提案定义了一个**位置强绑定**的游戏系统，解决了当前地图系统的不足：

### 问题
1. 玩家没有明确的"位置"概念
2. 地点之间没有连接性
3. 新地点无法渐进解锁
4. 环境对宝可梦没有影响
5. 野生宝可梦无差异化

### 解决方案
1. ✅ **强位置绑定** - 玩家总是在某个具体地点
2. ✅ **地点连接性** - 地点之间有地理关系
3. ✅ **渐进解锁** - 通过等级、徽章解锁新地点
4. ✅ **环境加成** - 地点环境对属性有 ±10% 的加成
5. ✅ **地点特定宝可梦** - 每个地点有独特的野生宝可梦池

## 🏗️ 文档结构

```
20251021-location-binding-system/
├── proposal.md              # 1. 提案目标和范围
├── design.md                # 2. 架构决策和设计方案
├── specs/                   # 3. 详细规范 (4个模块)
│   ├── location-binding/
│   ├── environment-bonus/
│   ├── map-unlocking/
│   └── wild-pokemon-system/
├── tasks.md                 # 4. 实现任务 (19个任务)
└── README.md                # 本文件
```

## 🎯 关键特性

### 1. 位置强绑定
```
游戏开始 → 玩家在常青小镇
          ↓
选择移动 → 查看连接地点
          ↓
选择目标 → 检查解锁条件
          ↓
移动成功 → 显示新位置信息
```

### 2. 环境加成系统
```
环境类型         加成
────────────────────
Grassland (草地)   速度 +10%
Forest (森林)      防守 +10%
Cave (洞穴)        特攻 +10%
Water (水域)       特防 +10%
Mountain (山地)    攻击 +10%
City (城市)        所有 +5%
```

### 3. 渐进地点解锁
```
常青小镇 (起始)
   ↓ (Lv3)
常青森林
   ↓ (Lv5)
华石镇
   ↓ (Lv7)
月见山
   ↓ (Lv15 + 1个徽章)
华蓝市
   ...逐步递进
```

### 4. 野生遭遇预览
```
野生宝可梦出现!
┌──────────────────┐
│ 名字: 皮卡丘      │
│ 等级: 5          │
│ 类型: 电系        │
│ 环境: 草地        │
│
│ 属性预览 (+10%):
│   速度: 90 → 99  │
│
│ 1. 捕捉  2. 战斗  3. 逃跑
└──────────────────┘
```

## 📊 规范详情

### 1. location-binding/spec.md
- **4个要求**, **11个场景**
- 定义位置绑定的所有行为
- 地点连接性规则
- 访问状态追踪

### 2. environment-bonus/spec.md
- **3个要求**, **8个场景**
- 环境加成计算
- 属性加成的展示
- 舍入和精度处理

### 3. map-unlocking/spec.md
- **3个要求**, **7个场景**
- 渐进解锁逻辑
- 解锁条件显示
- 解锁通知系统

### 4. wild-pokemon-system/spec.md
- **4个要求**, **8个场景**
- 地点宝可梦池
- 加权随机遭遇
- 遭遇预览系统

**总计**: 14 个要求, 34 个测试场景

## 📋 实现任务

### 分阶段计划
- **Phase 1**: 基础位置系统 (3任务, 5.5h)
- **Phase 2**: 环境加成系统 (2任务, 2.5h)
- **Phase 3**: 地点解锁系统 (3任务, 5h)
- **Phase 4**: 野生宝可梦系统 (2任务, 3.5h)
- **Phase 5**: UI/UX 系统 (2任务, 2.5h)
- **Phase 6**: 游戏循环集成 (2任务, 3.5h)
- **Phase 7**: 测试与验证 (3任务, 3.5h)
- **Phase 8**: 数据迁移 (2任务, 2h)

**总计**: 19 个任务, ~28 小时开发时间

### 并行化机会
- Tasks 1.1 & 1.2 (基础结构)
- Tasks 2.1 & 3.1 (独立模块)
- Tasks 4.1 & 5.1 (后端 & 前端)

可缩短 25-30% 的时间。

## 🔍 设计决策

### 为什么强绑定位置?
✅ **优势**:
- 清晰的位置感
- 易于管理游戏状态
- 强RPG体验
- 清晰的进度感

❌ **劣势**:
- 需要菜单移动
- 限制玩家自由度

### 为什么 ±10% 加成?
- 太小 (±1-5%): 玩家察觉不到
- **合适 (±10%)**: 战术相关但不主导胜负
- 太大 (±20%+): 打破游戏平衡

### 为什么多条件 AND 模型?
```
需要条件: Lv15 + 1个徽章 + 3只宝可梦
这意味着: 必须同时满足所有三个条件
优势: 清晰、可预测、易于调整
```

## 📦 交付物

实施后将产生:

### 新增文件
```
src/
├── game/
│   ├── location.rs         (~150 lines)
│   ├── environment.rs      (~100 lines)
│   ├── requirements.rs     (~120 lines)
│   └── wild_pokemon.rs     (~180 lines)
├── cli/
│   └── location_menu.rs    (~150 lines)
├── data/
│   └── locations_data.rs   (~200 lines)
└── lib.rs                  (新增)

tests/
└── location_system_test.rs (~300 lines)
```

### 修改文件
```
src/
├── game/player.rs          (+80 lines)
├── game/mod.rs             (+4 lines)
├── cli/menu.rs             (+40 lines)
├── cli/mod.rs              (+2 lines)
├── main.rs                 (+150 lines)
└── pokemon_generator/
    └── generator.rs        (+30 lines)
```

### 统计数据
- **新增代码**: ~1300 lines
- **修改代码**: ~300 lines
- **新增测试**: 20+ tests
- **总测试数**: 61+ tests (41 existing + 20 new)

## ✅ 验收标准

完成后应满足:
- [ ] 所有 19 个任务完成
- [ ] 所有 20+ 个新测试通过
- [ ] Release 编译无误
- [ ] 无 panic! 调用
- [ ] 向后兼容现有存档
- [ ] UI 清晰易用
- [ ] 代码审查通过

## 🚀 后续步骤

1. **审核本提案** - 评论意见并讨论
2. **使用 `/openspec:apply`** - 开始实施
3. **按任务顺序完成** - 参考 tasks.md
4. **完成后存档** - 使用 `/openspec:archive`

---

**创建日期**: 2025-10-21
**状态**: ✅ 提案完成
**下一步**: 等待审核和批准实施

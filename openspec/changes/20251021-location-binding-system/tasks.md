# 位置强绑定系统 - 实现任务列表

## Phase 1: 基础位置系统 (2天)

### Task 1.1: 创建位置数据结构
- **文件**: `src/game/location.rs` (新建)
- **内容**:
  - Location 结构体
  - EnvironmentType 枚举
  - EnvironmentBonus 结构体
  - WildPokemonSpawn 结构体
  - LocationRequirement 结构体
- **验证**:
  - 编译无误
  - 所有字段都能正确序列化
- **预期时间**: 2小时

### Task 1.2: 创建玩家位置状态
- **文件**: `src/game/player.rs` (修改)
- **内容**:
  - 添加 `current_location_id: u32` 字段
  - 添加 `location_state: PlayerLocationState` 字段
  - 添加位置相关方法: `get_current_location()`, `move_to_location()`
- **验证**:
  - Player 结构体编译无误
  - 位置字段可正确序列化
- **预期时间**: 1.5小时

### Task 1.3: 创建位置数据库
- **文件**: `src/data/locations_data.rs` (新建)
- **内容**:
  - 定义所有 11 个地点
  - 每个地点配置:
    - 连接关系 (connected_locations)
    - 环境类型
    - 野生宝可梦池
    - 解锁条件
- **验证**:
  - 地点数据完整 (11个地点)
  - 连接关系无矛盾
  - 编译无误
- **依赖**: Task 1.1
- **预期时间**: 2小时

---

## Phase 2: 环境加成系统 (1.5天)

### Task 2.1: 实现环境加成计算
- **文件**: `src/game/environment.rs` (新建)
- **内容**:
  - 实现 EnvironmentBonus::apply_to_stat()
  - 实现环境类型到加成的映射
  - 实现浮点舍入逻辑
- **验证**:
  - 加成计算正确 (10% 精度)
  - 舍入一致
  - 单元测试覆盖所有环境类型
- **预期时间**: 1小时

### Task 2.2: 集成加成到宝可梦生成
- **文件**: `src/pokemon_generator/generator.rs` (修改)
- **内容**:
  - 添加 `apply_environment_bonus()` 方法
  - 在野生遭遇时应用加成
  - 在预览中显示原始+加成属性
- **验证**:
  - 野生宝可梦预览显示加成
  - 实际战斗不使用加成
- **依赖**: Task 2.1
- **预期时间**: 1.5小时

---

## Phase 3: 地点解锁系统 (2天)

### Task 3.1: 实现解锁条件检查
- **文件**: `src/game/requirements.rs` (新建)
- **内容**:
  - 实现 LocationRequirement 的检查逻辑
  - 支持等级检查
  - 支持徽章检查
  - 支持宝可梦数量检查
  - 生成友好的解锁条件文本
- **验证**:
  - 单元测试覆盖所有条件组合
  - 条件检查逻辑正确
- **预期时间**: 2小时

### Task 3.2: 创建解锁状态追踪
- **文件**: `src/game/player.rs` (修改)
- **内容**:
  - 添加 `unlocked_locations: HashSet<u32>`
  - 添加 `visited_locations: HashSet<u32>`
  - 实现 `check_location_unlock()` 方法
  - 实现 `get_newly_unlocked_locations()` 方法
- **验证**:
  - 解锁状态正确追踪
  - 持久化正确
- **依赖**: Task 3.1
- **预期时间**: 1.5小时

### Task 3.3: 实现地点移动逻辑
- **文件**: `src/game/location.rs` (修改)
- **内容**:
  - 实现 `can_move_to()` 检查连接性
  - 实现 `is_location_unlocked()` 检查解锁
  - 实现 `move_location()` 方法
  - 生成移动错误信息
- **验证**:
  - 不能移动到未解锁地点
  - 不能移动到不相邻地点
  - 可以移动到已解锁且相邻的地点
- **依赖**: Task 1.1, 3.1
- **预期时间**: 1.5小时

---

## Phase 4: 野生宝可梦系统 (2天)

### Task 4.1: 实现野生宝可梦池
- **文件**: `src/game/wild_pokemon.rs` (新建)
- **内容**:
  - 实现 WildPokemonPool 结构体
  - 实现加权随机选择
  - 实现等级随机化
  - 实现 `encounter_pokemon()` 方法
- **验证**:
  - 加权选择分布正确
  - 等级范围正确
  - 单元测试验证分布
- **预期时间**: 2小时

### Task 4.2: 实现遭遇预览
- **文件**: `src/game/wild_pokemon.rs` (修改)
- **内容**:
  - 实现 WildPokemonPreview 结构体
  - 计算和存储预览信息
  - 包括环境加成的属性预览
- **验证**:
  - 预览包含所有必要信息
  - 属性预览正确应用加成
- **依赖**: Task 2.1, 4.1
- **预期时间**: 1.5小时

---

## Phase 5: UI/UX 系统 (1.5天)

### Task 5.1: 创建位置菜单
- **文件**: `src/cli/location_menu.rs` (新建)
- **内容**:
  - 实现位置信息显示菜单
  - 实现移动菜单 (显示可达地点)
  - 实现解锁条件显示
  - 实现遭遇预览菜单
- **验证**:
  - 菜单格式清晰
  - 所有信息可读性好
- **预期时间**: 1.5小时

### Task 5.2: 更新游戏菜单
- **文件**: `src/cli/menu.rs` (修改)
- **内容**:
  - 在主菜单顶部显示位置
  - 添加"移动"选项
  - 显示已访问地点计数
- **验证**:
  - 菜单布局合理
  - 新选项工作正常
- **依赖**: Task 5.1
- **预期时间**: 1小时

---

## Phase 6: 游戏循环集成 (1.5天)

### Task 6.1: 修改游戏循环
- **文件**: `src/main.rs` (修改)
- **内容**:
  - 在 start_game() 中初始化玩家位置
  - 添加 move_location() 处理函数
  - 添加 explore_at_location() 处理函数
  - 更新主菜单显示位置
  - 每回合检查新解锁的地点
- **验证**:
  - 游戏启动玩家在正确位置
  - 移动功能正常
  - 解锁通知显示
- **依赖**: Task 3.3, 5.2
- **预期时间**: 2小时

### Task 6.2: 集成野生遭遇
- **文件**: `src/main.rs` (修改)
- **内容**:
  - 在探索时使用地点的野生宝可梦池
  - 应用地点遭遇率
  - 显示遭遇预览菜单
  - 根据玩家选择进入捕捉/战斗/逃跑
- **验证**:
  - 遭遇来自正确的地点池
  - 预览显示正确
  - 战斗/捕捉/逃跑正常工作
- **依赖**: Task 4.2, 5.1
- **预期时间**: 1.5小时

---

## Phase 7: 测试与验证 (1.5天)

### Task 7.1: 单元测试
- **文件**: `tests/location_system_test.rs` (新建)
- **内容**:
  - 位置系统测试 (8-10 个)
  - 环境加成测试 (6-8 个)
  - 解锁系统测试 (8-10 个)
  - 野生宝可梦测试 (6-8 个)
- **目标**: 覆盖所有核心逻辑
- **预期时间**: 1.5小时

### Task 7.2: 集成测试
- **文件**: `tests/location_system_test.rs` (修改)
- **内容**:
  - 完整游戏流程测试
  - 移动->遭遇->战斗 流程
  - 解锁->移动 流程
- **预期时间**: 1小时

### Task 7.3: 编译与发布验证
- **命令**: `cargo build --release`
- **验证**:
  - Release 版本编译无误
  - 所有测试通过 (41+ 个)
  - 无警告 (或仅已知警告)
- **预期时间**: 1小时

---

## Phase 8: 数据迁移与兼容性 (1天)

### Task 8.1: 存档迁移
- **文件**: `src/game/player.rs` (修改)
- **内容**:
  - 实现 `migrate_old_save()` 函数
  - 为旧存档添加位置信息 (默认为常青小镇)
  - 为旧存档初始化解锁状态
- **验证**:
  - 旧存档可以正确加载
  - 位置信息正确初始化
- **预期时间**: 1小时

### Task 8.2: 向后兼容性验证
- **内容**:
  - 验证现有地点信息兼容
  - 验证现有对战逻辑不受影响
  - 验证保存/加载功能正常
- **预期时间**: 1小时

---

## 总体时间估计

| Phase | 任务数 | 预期时间 |
|-------|--------|---------|
| Phase 1 | 3 | 5.5 小时 |
| Phase 2 | 2 | 2.5 小时 |
| Phase 3 | 3 | 5 小时 |
| Phase 4 | 2 | 3.5 小时 |
| Phase 5 | 2 | 2.5 小时 |
| Phase 6 | 2 | 3.5 小时 |
| Phase 7 | 3 | 3.5 小时 |
| Phase 8 | 2 | 2 小时 |
| **总计** | **19** | **28 小时** |

---

## 并行化建议

可以并行进行的任务:
- Task 1.1 & 1.2 (都是基础结构)
- Task 2.1 & 3.1 (独立模块)
- Task 4.1 & 5.1 (后端 & 前端)

通过并行可缩短约 25-30% 的时间。

---

## 依赖关系图

```
Task 1.1 ──┬─→ Task 1.3
           └─→ Task 3.1

Task 2.1 ──→ Task 2.2
           ├─→ Task 4.2

Task 3.1 ──→ Task 3.2
           ├─→ Task 3.3

Task 4.1 ──→ Task 4.2
           └─→ Task 6.2

Task 5.1 ──→ Task 5.2 ──→ Task 6.1

Task 6.1 ──→ Task 6.2
           └─→ Task 7.1

Task 7.1 ──→ Task 7.2 ──→ Task 7.3

Task 8.1 ──→ Task 8.2
```

---

**准备就绪**: 所有任务定义完毕，可以开始实施！
使用 `/openspec:apply 20251021-location-binding-system` 开始。

# 地图与NPC对战系统 - 任务分解

## 总体任务流程

```
第一阶段 (基础数据结构) ──┐
                      ├─→ 第三阶段 (宝可梦生成) ──┐
第二阶段 (地图和NPC)  ──┘                        ├─→ 第五阶段 (集成与测试)
                                                ↑
                                           第四阶段 (对战系统)
```

## 第一阶段：基础数据结构与模块创建

### 任务 1.1: 创建地图模块骨架
- **文件**: `src/map/mod.rs`
- **内容**:
  - 定义 Location 结构体
  - 定义 Region 结构体
  - 定义 GameMap 结构体
- **验证**: 代码编译通过，无错误

### 任务 1.2: 创建 NPC 模块骨架
- **文件**: `src/npc/mod.rs`
- **内容**:
  - 定义 NPCTrainer 结构体
  - 定义 Difficulty 枚举
  - 定义 BattlePreview 结构体
- **验证**: 代码编译通过

### 任务 1.3: 创建宝可梦生成模块
- **文件**: `src/pokemon_generator/mod.rs`
- **内容**:
  - 定义 IndividualValues 结构体
  - 定义 Talent 枚举
  - 定义 Nature 枚举
  - 定义 PokemonInstance 结构体
- **验证**: 代码编译通过

### 任务 1.4: 实现 Serialize/Deserialize traits
- **文件**: 上述所有文件
- **内容**: 为所有新结构体添加序列化支持
- **验证**: 可以正确序列化和反序列化

---

## 第二阶段：地图和NPC数据

### 任务 2.1: 创建地点数据库
- **文件**: `src/map/locations.rs`
- **内容**:
  - 创建至少 8 个地点
  - 每个地点关联 NPC 列表
  - 每个地点关联可遭遇的宝可梦
- **示例**:
  - 常青小镇 (新手区)
  - 常青森林 (新手森林)
  - 金黄市 (馆主)
  - 华蓝市
  - 月见山
  - 等等...
- **验证**:
  ```bash
  # 可以通过 ID 加载任意地点
  # 每个地点有正确的 NPC 和宝可梦列表
  ```

### 任务 2.2: 创建 NPC 数据库
- **文件**: `src/npc/trainers.rs`
- **内容**:
  - 创建 10+ 个 NPC
  - 每个 NPC 有独特的队伍组成
  - 分配不同的难度等级
- **示例 NPC**:
  - 青绿 (劲敌) - 等级 5, 队伍: [妙蛙种子, 小火龙, 杰尼龟]
  - 馆主美娜 (水系) - 等级 20, 队伍: [星星, 海星星, 刺龙王]
  - 馆主蕾欧娜 (电系) - 等级 22, 队伍: [皮卡丘, 电击兽, 电池怪]
  - 等等...
- **验证**:
  ```bash
  # 可以通过 ID 加载任意 NPC
  # 每个 NPC 有独特的数据
  ```

### 任务 2.3: 地点和 NPC 的关联
- **文件**: `src/map/mod.rs`
- **内容**:
  - 实现地点加载时自动加载相关 NPC
  - 实现"已击败"状态追踪
  - 实现访问过的地点记录
- **验证**:
  ```bash
  # 访问地点时能获取该地点的所有 NPC
  # 可以记录和查询已击败状态
  ```

---

## 第三阶段：宝可梦生成系统 (核心)

### 任务 3.1: 实现个体值 (IV) 生成
- **文件**: `src/pokemon_generator/mod.rs`
- **内容**:
  ```rust
  pub fn generate_iv() -> IndividualValues {
      // 为每个属性随机生成 0-31 的 IV
  }
  ```
- **验证**:
  ```bash
  # 生成 1000 个 IV，验证分布均匀
  # 每个 IV 都在 0-31 范围
  ```

### 任务 3.2: 实现天赋系统
- **文件**: `src/pokemon_generator/talents.rs`
- **内容**:
  - 为每个宝可梦物种定义可用天赋
  - 实现天赋随机选择
  - 实现天赋效果应用
- **示例**:
  ```rust
  fn get_available_talents(pokemon_id: u32) -> Vec<Talent> {
      match pokemon_id {
          25 => vec![Talent::StaticElectricity, Talent::Lightning], // 皮卡丘
          7 => vec![Talent::Torrent, Talent::WaterAbsorb],  // 杰尼龟
          4 => vec![Talent::Blaze, Talent::FlashFire],      // 小火龙
      }
  }
  ```
- **验证**:
  - 不同宝可梦有不同的天赋池
  - 天赋随机选择

### 任务 3.3: 实现性格系统
- **文件**: `src/pokemon_generator/natures.rs`
- **内容**:
  - 实现 25 种性格
  - 实现性格属性加成计算
  - 实现随机选择
- **验证**:
  ```bash
  # 验证性格影响属性正确
  # 例: Adamant (攻击 +10%, 特攻 -10%)
  ```

### 任务 3.4: 实现属性计算公式
- **文件**: `src/pokemon_generator/mod.rs`
- **内容**:
  ```rust
  pub fn calculate_stat(
      base_stat: u32,
      iv: u32,
      level: u32,
      nature: Nature,
  ) -> u32 {
      // 公式: ((2 * base_stat + IV) * level / 100) + level + 5
      // 然后应用性格加成
  }
  ```
- **验证**:
  ```bash
  # 单元测试:
  # - 无性格时计算正确
  # - 正性格时加成正确 (+10%)
  # - 负性格时减成正确 (-10%)
  ```

### 任务 3.5: 实现唯一性检查系统
- **文件**: `src/pokemon_generator/registry.rs`
- **内容**:
  ```rust
  pub struct PokemonRegistry {
      existing_pokemon: HashSet<u64>,
  }

  impl PokemonRegistry {
      pub fn generate_unique_id(&mut self, instance: &PokemonInstance) -> u64;
      pub fn is_unique(&self, id: u64) -> bool;
      pub fn register(&mut self, id: u64);
  }
  ```
- **验证**:
  ```bash
  # 生成 1000 个宝可梦，验证全部唯一
  # 同一数据生成相同 ID
  ```

### 任务 3.6: 实现 PokemonInstance 创建
- **文件**: `src/pokemon_generator/mod.rs`
- **内容**:
  ```rust
  pub fn create_pokemon_instance(
      pokemon_id: u32,
      level: u32,
      difficulty: Difficulty,
  ) -> PokemonInstance {
      // 整合 IV, 天赋, 性格等
  }
  ```
- **验证**:
  ```bash
  # 创建宝可梦实例
  # 验证所有字段正确初始化
  # 验证属性计算正确
  ```

### 任务 3.7: 为宝可梦分配招式
- **文件**: `src/pokemon_generator/move_pool.rs`
- **内容**:
  - 为每个宝可梦定义可学招式池
  - 根据等级和难度选择招式
  - 最多选择 4 个招式
- **验证**:
  ```bash
  # 不同等级的宝可梦有不同招式
  # 高等级有更强招式
  ```

---

## 第四阶段：对战系统增强与集成

### 任务 4.1: 修改战斗系统支持 NPC 对战
- **文件**: `src/game/battle.rs`
- **内容**:
  - 添加 `is_npc_battle` 标志
  - 修改奖励计算以支持 NPC 固定奖励
  - 修改逃跑逻辑 (NPC 对战可能不允许逃跑)
- **验证**: 编译通过，对战逻辑不变

### 任务 4.2: 实现对战前预览
- **文件**: `src/cli/battle_preview.rs` (新文件)
- **内容**:
  ```rust
  pub fn display_battle_preview(preview: &BattlePreview) {
      // 显示 NPC 名字、职位
      // 显示 NPC 队伍
      // 显示奖励信息
      // 显示推荐等级和难度
  }
  ```
- **验证**: 显示格式正确

### 任务 4.3: 实现 NPC 对战流程
- **文件**: `src/main.rs` (修改 battle_wild 函数)
- **内容**:
  - 区分"野生对战"和"NPC对战"
  - NPC 对战时加载 PokemonInstance
  - 对战后更新 NPC 击败状态
- **验证**: NPC 对战完整流程

### 任务 4.4: 实现奖励系统
- **文件**: `src/game/player.rs` (添加方法)
- **内容**:
  ```rust
  pub fn receive_npc_reward(
      &mut self,
      money: u32,
      items: Vec<String>,
  ) {
      self.add_money(money);
      for item in items {
          self.add_item(item, 1);
      }
  }
  ```
- **验证**: 正确发放金币和道具

---

## 第五阶段：地图导航与游戏循环

### 任务 5.1: 实现地图导航菜单
- **文件**: `src/cli/map_menu.rs` (新文件)
- **内容**:
  ```
  地图菜单
  ├─ 显示所有区域
  ├─ 显示已访问地点数
  ├─ 选择地点进入
  └─ 返回主菜单
  ```
- **验证**: 菜单导航正常

### 任务 5.2: 实现地点选择菜单
- **文件**: `src/cli/location_menu.rs` (新文件)
- **内容**:
  - 显示地点信息
  - 显示该地点的 NPC 列表
  - 显示该地点的野生宝可梦
  - 选择 NPC 进行对战
- **验证**: 信息显示正确

### 任务 5.3: 实现 NPC 列表菜单
- **文件**: `src/cli/npc_list_menu.rs` (新文件)
- **内容**:
  - 显示 NPC 名字和职位
  - 显示 NPC 击败状态
  - 显示推荐等级
  - 选择 NPC 查看预览或对战
- **验证**: 列表显示正确

### 任务 5.4: 修改主菜单添加地图选项
- **文件**: `src/cli/menu.rs`
- **内容**:
  ```
  主菜单
  ├─ 探索 (原有)
  ├─ 地图 (新增)  ← 新增
  ├─ 队伍
  ├─ 背包
  └─ 退出
  ```
- **验证**: 编译通过，菜单显示正确

### 任务 5.5: 修改游戏循环集成地图系统
- **文件**: `src/main.rs`
- **内容**:
  - 在主游戏循环中添加地图选项
  - 调用地图导航函数
  - 处理地图对战返回
- **验证**: 完整的地图流程

---

## 第六阶段：高级功能和打磨

### 任务 6.1: 实现进度追踪
- **文件**: `src/game/player.rs`
- **内容**:
  - 记录访问过的地点
  - 记录击败的 NPC
  - 显示完成进度百分比
- **验证**: 进度正确计算

### 任务 6.2: 实现难度选择
- **文件**: `src/cli/difficulty_menu.rs`
- **内容**:
  - 显示不同难度选项
  - 显示对应的对手等级
  - 显示奖励差异
- **验证**: 难度选择影响对战

### 任务 6.3: 实现属性详情页面
- **文件**: `src/cli/pokemon_detail.rs`
- **内容**:
  - 显示完整的宝可梦属性
  - 显示 IV 值
  - 显示天赋和性格
  - 显示唯一 ID
- **验证**: 显示格式正确

### 任务 6.4: 实现天赋效果系统
- **文件**: `src/game/battle.rs`
- **内容**:
  - 在战斗中应用天赋效果
  - 例: 威吓降低对手攻击
  - 例: 火焰系低血量加成
- **验证**: 天赋正确应用于战斗

### 任务 6.5: 实现宝可梦收集信息系统
- **文件**: `src/game/player.rs`
- **内容**:
  - 记录已捕捉的宝可梦 IV 统计
  - 记录最佳性格宝可梦
  - 显示收集进度
- **验证**: 统计信息正确

---

## 第七阶段：测试和验证

### 任务 7.1: 单元测试 - IV 系统
- **文件**: `tests/iv_system_test.rs`
- **内容**:
  - 测试 IV 生成范围 (0-31)
  - 测试 IV 分布
  - 测试属性计算公式
- **验证**: 所有测试通过

### 任务 7.2: 单元测试 - 天赋系统
- **文件**: `tests/talent_system_test.rs`
- **内容**:
  - 测试天赋选择
  - 测试宝可梦能获得有效天赋
  - 测试天赋效果应用
- **验证**: 所有测试通过

### 任务 7.3: 单元测试 - 性格系统
- **文件**: `tests/nature_system_test.rs`
- **内容**:
  - 测试所有 25 种性格
  - 测试属性加成正确性
  - 测试性格影响
- **验证**: 所有测试通过

### 任务 7.4: 单元测试 - 唯一性系统
- **文件**: `tests/uniqueness_test.rs`
- **内容**:
  - 生成 1000+ 个宝可梦
  - 验证全部唯一
  - 测试冲突处理
- **验证**: 无重复宝可梦

### 任务 7.5: 集成测试 - 完整对战流程
- **文件**: `tests/npc_battle_integration_test.rs`
- **内容**:
  - 地图导航
  - NPC 对战
  - 奖励发放
  - 状态更新
- **验证**: 完整流程正常工作

### 任务 7.6: 平衡测试
- **文件**: `测试文档`
- **内容**:
  - 对战难度梯度合理
  - 奖励金币数量平衡
  - IV 分布合理
  - 天赋能力平衡
- **验证**: 游戏平衡感良好

---

## 第八阶段：文档和发布

### 任务 8.1: 更新 README
- 添加地图系统说明
- 添加宝可梦生成系统说明
- 添加 NPC 对战说明

### 任务 8.2: 更新 GAMEPLAY 指南
- 添加地图导航教程
- 添加 NPC 对战策略
- 添加属性和天赋解释

### 任务 8.3: 创建 API 文档
- 记录公共 API
- 记录配置参数
- 记录扩展指南

### 任务 8.4: 代码审查和清理
- 移除未使用的代码
- 优化性能
- 检查错误处理

---

## 依赖关系图

```
第 3 阶段 (宝可梦生成系统)
├── IV 生成 ✓
├── 天赋系统 ✓
├── 性格系统 ✓
├── 唯一性系统 ✓
└── 招式分配 ✓
    ↓
第 2 阶段 (地图和NPC) + 第 4 阶段 (对战系统)
├── 地点数据库 ✓
├── NPC 数据库 ✓
├── 战斗系统修改 ✓
└── 奖励系统 ✓
    ↓
第 5 阶段 (导航和集成)
├── 地图菜单 ✓
├── 地点菜单 ✓
├── NPC 列表菜单 ✓
└── 游戏循环修改 ✓
    ↓
第 6 阶段 (高级功能)
├── 进度追踪 ✓
├── 难度选择 ✓
├── 属性显示 ✓
└── 天赋效果 ✓
    ↓
第 7 阶段 (测试)
└── 所有测试通过 ✓
    ↓
第 8 阶段 (发布)
└── 文档完成 ✓
```

---

## 并行工作机会

可以并行进行的工作：
- 第 2 阶段和第 4 阶段可以同时进行 (不相互依赖)
- 第 6 阶段的各个子任务可以并行
- 第 7 阶段可以在编码进行中并行进行

---

## 时间估计

| 阶段 | 任务数 | 估计时间 | 优先级 |
|------|--------|--------|--------|
| 第 1 阶段 | 4 | 2-3 小时 | ★★★ 必做 |
| 第 2 阶段 | 3 | 2 小时 | ★★★ 必做 |
| 第 3 阶段 | 7 | 4-5 小时 | ★★★ 核心 |
| 第 4 阶段 | 4 | 3 小时 | ★★★ 必做 |
| 第 5 阶段 | 5 | 3-4 小时 | ★★★ 必做 |
| 第 6 阶段 | 5 | 2-3 小时 | ★★ 增强 |
| 第 7 阶段 | 6 | 3-4 小时 | ★★ 重要 |
| 第 8 阶段 | 4 | 1-2 小时 | ★ 收尾 |

**总计**: 约 20-24 小时

---

## 检查清单

### 第 1 阶段
- [ ] 地图模块创建
- [ ] NPC 模块创建
- [ ] 宝可梦生成模块创建
- [ ] 所有代码编译通过

### 第 2 阶段
- [ ] 至少 8 个地点数据
- [ ] 至少 10 个 NPC 数据
- [ ] NPC 可通过地点加载
- [ ] 击败状态可追踪

### 第 3 阶段
- [ ] IV 系统完整
- [ ] 天赋系统完整
- [ ] 性格系统完整
- [ ] 属性计算正确
- [ ] 唯一性系统完整
- [ ] 招式分配正确

### 第 4 阶段
- [ ] 战斗系统支持 NPC
- [ ] 预览系统完整
- [ ] NPC 对战流程完整
- [ ] 奖励系统正确

### 第 5 阶段
- [ ] 地图菜单完整
- [ ] 地点菜单完整
- [ ] NPC 列表完整
- [ ] 主菜单集成
- [ ] 完整游戏循环

### 第 6 阶段
- [ ] 进度追踪可用
- [ ] 难度选择可用
- [ ] 属性显示完整
- [ ] 天赋效果应用

### 第 7 阶段
- [ ] IV 系统测试通过
- [ ] 天赋系统测试通过
- [ ] 性格系统测试通过
- [ ] 唯一性测试通过
- [ ] 集成测试通过
- [ ] 平衡测试通过

### 第 8 阶段
- [ ] README 更新
- [ ] GAMEPLAY 更新
- [ ] API 文档完成
- [ ] 代码审查完成

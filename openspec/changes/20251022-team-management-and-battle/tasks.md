# 队伍管理与战斗系统 - 实现任务列表

## 概览

总计 **19 个任务**，分为 **4 个阶段**，预计 **14 天**完成。

---

## Phase 1: 队伍详细信息系统 (3 天)

### Task 1.1: 扩展 Pokemon 数据结构

- **文件**: `src/game/pokemon.rs` (修改)
- **内容**:
  - 添加字段: `caught_with: String` (捕捉球类型)
  - 添加字段: `caught_location_id: u32` (捕捉地点 ID)
  - 添加字段: `caught_date: u64` (捕捉时间戳)
  - 更新 `Pokemon::new()` 初始化这些字段
- **验证**:
  - Pokemon 结构编译无误
  - 可正确序列化/反序列化
- **预期时间**: 1 小时

### Task 1.2: 创建队伍详细菜单

- **文件**: `src/cli/team_detail_menu.rs` (新建)
- **内容**:
  - 创建 `TeamDetailMenu` 结构体
  - 实现 `display_pokemon_detail()` - 显示单只宝可梦详情
  - 实现 `display_pokemon_stats()` - 显示属性和招式
  - 实现 `display_catch_info()` - 显示捕捉信息
  - 实现导航（上/下浏览）
- **验证**:
  - 菜单格式清晰，信息完整
  - 导航工作正常
- **预期时间**: 1.5 小时

### Task 1.3: 集成到游戏菜单

- **文件**: `src/main.rs` (修改)，`src/cli/mod.rs` (修改)
- **内容**:
  - 在查看队伍时添加 "查看详情" 选项
  - 链接到队伍详细菜单
  - 在详情菜单中添加 "放入仓库" 选项（与 Task 2.2 协调）
  - 添加返回上级菜单选项
- **验证**:
  - 菜单流畅，选项可用
- **预期时间**: 1 小时

---

## Phase 2: 宠物仓库系统 (4 天)

### Task 2.1: 创建存储系统数据结构

- **文件**: `src/game/storage.rs` (新建)
- **内容**:
  - 定义 `PokemonBox` 结构体
    - `box_id: u32` (箱子编号 1-20)
    - `name: String` (箱子名称)
    - `pokemon: Vec<Pokemon>` (最多 30 只)
  - 定义 `StorageSystem` 结构体
    - `boxes: Vec<PokemonBox>` (20 个箱子)
  - 实现 `StorageSystem::new()` - 初始化 20 个箱子
  - 实现 `add_pokemon()` - 添加宝可梦到第一个有空位的箱子
  - 实现 `remove_pokemon()` - 从指定箱子移除
  - 实现 `release_pokemon()` - 放生（删除）宝可梦
  - 实现 `rename_box()` - 重命名箱子
  - 实现 `get_storage_stats()` - 获取仓库统计信息
- **验证**:
  - 所有操作可正确执行
  - 容量限制工作正常
  - 单元测试覆盖所有方法
- **预期时间**: 2 小时

### Task 2.2: 创建仓库管理菜单

- **文件**: `src/cli/storage_menu.rs` (新建)
- **内容**:
  - 创建 `StorageMenu` 结构体
  - 实现 `display_storage_main()` - 主仓库菜单
  - 实现 `display_box_list()` - 显示箱子列表
  - 实现 `display_box_content()` - 显示箱子内容
  - 实现 `display_pokemon_in_box()` - 显示单只宝可梦
  - 实现 `display_storage_stats()` - 显示统计信息
  - 实现菜单导航和选择逻辑
- **验证**:
  - 菜单清晰易用
  - 所有操作可访问
- **预期时间**: 1.5 小时

### Task 2.3: 实现队伍-仓库交换

- **文件**: `src/game/player.rs` (修改)
- **内容**:
  - 添加 `storage_system: StorageSystem` 字段到 Player
  - 实现 `move_to_storage()` - 宝可梦移入仓库
  - 实现 `move_from_storage()` - 宝可梦移出仓库
  - 实现 `swap_team_and_storage()` - 快速交换
  - 验证队伍和仓库约束（队伍 ≤ 6，仓库箱子 ≤ 30）
- **验证**:
  - 交换逻辑正确
  - 约束得到遵守
- **预期时间**: 1 小时

### Task 2.4: 集成存储菜单到游戏

- **文件**: `src/main.rs` (修改)，`src/cli/mod.rs` (修改)
- **内容**:
  - 在主菜单中添加 "宠物仓库" 选项
  - 链接到存储菜单
  - 实现放生、查询、交换功能的菜单流程
  - 添加确认提示（特别是放生操作）
  - 处理边界情况（队伍满、仓库满等）
- **验证**:
  - 菜单流程完整
  - 所有功能可访问
- **预期时间**: 1 小时

---

## Phase 3: 战斗系统完整化 (5 天)

### Task 3.1: 扩展 Battle 数据结构

- **文件**: `src/game/battle.rs` (修改)
- **内容**:
  - 添加 `turn_count: u32` - 当前回合数
  - 添加 `battle_log: Vec<String>` - 战斗日志
  - 添加 `player_team: Vec<Pokemon>` - 玩家完整队伍
  - 添加 `opponent_team: Vec<Pokemon>` - 对手完整队伍
  - 添加 `current_player_index: usize` - 当前玩家宝可梦索引
  - 添加 `current_opponent_index: usize` - 当前对手宝可梦索引
  - 实现 `new()` 方法完整初始化
- **验证**:
  - 结构编译无误
  - 所有字段可正确初始化
- **预期时间**: 1 小时

### Task 3.2: 实现伤害计算系统

- **文件**: `src/game/battle.rs` (修改)
- **内容**:
  - 完善 `calculate_damage()` 方法
    - 基础伤害公式实现
    - 属性克制倍数计算
    - 随机因数 (0.85-1.0)
  - 实现 `get_type_effectiveness()` - 属性克制查表
  - 实现 `calculate_critical()` - 急所计算（可选）
- **验证**:
  - 伤害计算符合公式
  - 属性克制正确应用
  - 单元测试覆盖各种情况
- **预期时间**: 2 小时

### Task 3.3: 实现速度和行动顺序系统

- **文件**: `src/game/battle.rs` (修改)
- **内容**:
  - 实现 `determine_turn_order()` - 根据速度确定行动顺序
  - 实现 `execute_turn()` - 执行一个回合
  - 处理双方同时行动的边界情况
  - 如果玩家宝可梦被击败，跳过玩家行动
- **验证**:
  - 速度计算正确
  - 行动顺序符合预期
  - 边界情况处理妥当
- **预期时间**: 1.5 小时

### Task 3.4: 实现招式使用系统

- **文件**: `src/game/battle.rs` (修改)
- **内容**:
  - 实现 `use_move()` - 使用招式
    - 检查 PP 是否充足
    - 检查命中
    - 计算伤害
    - 更新 PP 和 HP
    - 添加战斗日志
  - 实现 `apply_move_effect()` - 应用招式效果（如果有）
- **验证**:
  - PP 消耗正确
  - 命中检查工作
  - 伤害应用正确
- **预期时间**: 1.5 小时

### Task 3.5: 实现道具使用系统

- **文件**: `src/game/battle.rs` (修改)
- **内容**:
  - 实现 `use_item_in_battle()` - 在战斗中使用道具
  - 实现 `restore_hp()` - 恢复 HP
  - 实现 `cure_status()` - 清除异常状态（如果支持）
  - 验证道具数量充足
  - 添加战斗日志
- **验证**:
  - 道具效果正确
  - 数量更新正确
- **预期时间**: 1 小时

### Task 3.6: 实现宝可梦切换系统

- **文件**: `src/game/battle.rs` (修改)
- **内容**:
  - 实现 `switch_pokemon()` - 切换宝可梦
  - 更新当前宝可梦索引
  - 检查目标宝可梦是否昏迷
  - 对手可以进行一次无代价的攻击（可选，暂不实现）
  - 添加战斗日志
- **验证**:
  - 切换逻辑正确
  - 队伍约束得到遵守
- **预期时间**: 1 小时

### Task 3.7: 实现逃跑系统

- **文件**: `src/game/battle.rs` (修改)
- **内容**:
  - 实现 `attempt_escape()` - 尝试逃脱
  - 60% 成功率（可配置）
  - 失败时对手进行一次攻击
  - NPC 战斗无法逃跑（标志位）
- **验证**:
  - 逃跑概率符合预期
  - 失败时对手攻击正确
  - NPC 战斗无法逃脱
- **预期时间**: 1 小时

### Task 3.8: 实现战斗结算系统

- **文件**: `src/game/battle.rs` (修改)
- **内容**:
  - 实现 `check_battle_end()` - 检查战斗是否结束
  - 实现 `calculate_rewards()` - 计算经验值和金钱奖励
  - 实现 `apply_battle_results()` - 应用战斗结果到玩家
  - 处理升级和新招式学习
- **验证**:
  - 胜负判定正确
  - 奖励计算合理
  - 升级逻辑工作
- **预期时间**: 1.5 小时

### Task 3.9: 创建战斗菜单和显示

- **文件**: `src/cli/battle_menu.rs` (新建或扩展)
- **内容**:
  - 实现 `display_battle_status()` - 显示双方状态
  - 实现 `display_battle_options()` - 显示战斗菜单
  - 实现 `display_move_selection()` - 显示招式选择
  - 实现 `display_item_selection()` - 显示道具选择
  - 实现 `display_switch_menu()` - 显示切换宝可梦菜单
  - 实现 `display_battle_log()` - 显示战斗日志
- **验证**:
  - 菜单清晰易懂
  - 信息完整
- **预期时间**: 2 小时

### Task 3.10: 集成战斗到游戏循环

- **文件**: `src/main.rs` (修改)
- **内容**:
  - 更新野生宝可梦战斗处理 (Task 6.2 中的 `explore_location_encounter`)
  - 更新 NPC 训练师战斗处理
  - 实现完整的战斗循环
  - 处理战斗结束后的状态恢复
- **验证**:
  - 战斗可以正常进行
  - 战斗结束正确返回
  - 结果正确应用
- **预期时间**: 2 小时

---

## Phase 4: 测试与集成 (2 天)

### Task 4.1: 编写单元测试

- **文件**: `tests/team_storage_battle_test.rs` (新建)
- **内容**:
  - 队伍详细信息测试 (5-7 个)
  - 仓库系统测试 (8-10 个)
    - 添加/移除宝可梦
    - 放生机制
    - 容量限制
    - 箱子管理
  - 战斗系统测试 (10-15 个)
    - 伤害计算
    - 速度和顺序
    - 状态更新
    - 战斗结算
- **目标**: 覆盖 > 80% 代码
- **预期时间**: 1 小时

### Task 4.2: 集成测试与调试

- **文件**: `tests/` (修改现有测试)
- **内容**:
  - 完整游戏流程测试：捕捉 -> 存储 -> 战斗 -> 升级
  - 队伍和仓库交互测试
  - 战斗完整流程测试
  - 边界情况测试
- **预期时间**: 1 小时

### Task 4.3: 编译和发布验证

- **内容**:
  - `cargo build --release` 编译
  - 所有测试通过
  - 代码无警告（或仅已知警告）
  - 更新 README 和文档
- **预期时间**: 0.5 小时

---

## 时间表

| Phase | 任务数 | 预期时间 | 实际时间 |
|-------|--------|---------|---------|
| Phase 1 | 3 | 3.5 小时 | |
| Phase 2 | 4 | 5.5 小时 | |
| Phase 3 | 10 | 16 小时 | |
| Phase 4 | 3 | 2.5 小时 | |
| **总计** | **20** | **27.5 小时** | |

**假设工作时间** 8 小时/天 = **3-4 天**

---

## 依赖关系

```
Task 1.1 ──┬─→ Task 1.2
           │    └─→ Task 1.3
           │
           └─→ Task 2.1 ──┬─→ Task 2.2
                         ├─→ Task 2.3
                         └─→ Task 2.4
                              ↓
                    Task 3.1 ──┬─→ Task 3.2
                               ├─→ Task 3.3
                               ├─→ Task 3.4
                               ├─→ Task 3.5
                               ├─→ Task 3.6
                               ├─→ Task 3.7
                               ├─→ Task 3.8
                               ├─→ Task 3.9
                               └─→ Task 3.10
                                   ↓
                    Task 4.1 ──→ Task 4.2 ──→ Task 4.3
```

---

## 并行化建议

以下任务可以并行进行（如有多人合作）：
- Task 1.2 & Task 2.1 (UI & 后端)
- Task 3.2 & Task 3.3 & Task 3.4 (战斗系统的不同部分)

---

## 风险和缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 伤害计算公式复杂性 | 中 | 中 | 详细的单元测试和参考实现 |
| 战斗流程 bug | 高 | 高 | 详细的战斗日志便于调试 |
| 存档兼容性 | 中 | 中 | 实现向后兼容的迁移 |
